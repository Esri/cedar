<script src="//d3js.org/d3.v3.min.js"></script>
<script src="//vega.github.io/vega/vega.js"></script>

<script src="//vega.github.io/vega-lite/vega-lite.js"></script>
<script src="//vega.github.io/vega-editor/vendor/vega-embed.js" charset="utf-8"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/then-request/2.2.0/request.js"></script>
<script type="text/javascript" src="../../src/cedar.js"></script>


<div id="testEverything">

</div>

<div id="vis"></div>

  <div id="chart"></div>



<script>
// Cedar
//create a cedar chart
// var chart = new Cedar({"type": "bar"});
//
// //create the dataset w/ mappings
// var dataset = {
//   "url":"https://services2.arcgis.com/1cdV1mIckpAyI7Wo/arcgis/rest/services/Public_Schools/FeatureServer/0",
//   "query": {
//     "groupByFieldsForStatistics": "COUNTY",
//     "outStatistics": [{
//       "statisticType": "sum",
//       "onStatisticField": "POPULATION",
//       "outStatisticFieldName": "POPULATION_SUM"
//     }]
//   },
//   "mappings":{
//     "x": {"field":"COUNTY","label":"Population by county"},
//     "y": {"field":"POPULATION_SUM","label":"County"}
//   }
// };
//
// //assign to the chart
// chart.dataset = dataset;
//
// // fix placement of axes label
//
// // chart.tooltip = {
// //   "id": "cedar-tooltip",
// //   "title": "{Zip}",
// //   "content": "{Number_of_SUM} students in the {Zip} zipcode."
// // };
//
// //show the chart
// chart.show({
//   elementId: "#chart",
//   height: 750,
//   width: 750
// });

// //
// // // Vega Lite test
// request('GET', 'http://maps2.dcgis.dc.gov/dcgis/rest/services/DCGIS_DATA/Cultural_and_Society_WebMercator/MapServer/51/query?where=ART_TYPE%20%3D%20%27Mural%27&returnGeometry=false&returnDistinctValues=false&returnIdsOnly=false&returnCountOnly=false&outFields=*&f=json&groupByFieldsForStatistics=MEDIUM&outStatistics=%5B%7B%22statisticType%22%3A%22count%22%2C%22onStatisticField%22%3A%22OBJECTID%22%2C%22outStatisticFieldName%22%3A%22count_SUM%22%7D%5D&orderByFields=count_SUM%20DESC')
//   .done(function(res) {
//     var response = JSON.parse(res.getBody());
//     console.log(response);
//     var data = response.features.map(function(attr) { return attr.attributes; });
//     console.log(data);
//     var vlSpec = {
//     "data": {
//       "values": data
//     },
//     "mark": "bar",
//     "encoding": {
//       "x": {"field": "MEDIUM", "type": "nominal"},
//       "y": {
//         "field": "count_SUM", "type": "quantitative",
//         "axis": {
//           "title": "Average of b"
//         }
//       }
//     }
//   };
//   var embedSpec = {
//     mode: "vega-lite",  // Instruct Vega-Embed to use the Vega-Lite compiler
//     spec: vlSpec,
//     actions: {
//       export: false,
//       source: false,
//       editor: false
//     }
//   };
//   // Embed the visualization in the container with id `vis`
//   vg.embed("#vis", embedSpec, function(error, result) {
//     // Callback receiving the View instance and parsed Vega spec
//     // result.view is the View, which resides under the '#vis' element
//     console.log(result);
//   });
// });
//
// // pull everything in test
// //

request('GET', 'https://services2.arcgis.com/1cdV1mIckpAyI7Wo/arcgis/rest/services/Public_Schools/FeatureServer/0/query?where=1%3D1&objectIds=&time=&geometry=&geometryType=esriGeometryEnvelope&inSR=&spatialRel=esriSpatialRelIntersects&resultType=none&distance=&units=esriSRUnit_Meter&outFields=*&returnGeometry=false&multipatchOption=&maxAllowableOffset=&geometryPrecision=&outSR=&returnIdsOnly=false&returnCountOnly=false&returnExtentOnly=false&returnDistinctValues=false&orderByFields=&groupByFieldsForStatistics=&outStatistics=&resultOffset=&resultRecordCount=&returnZ=false&returnM=false&quantizationParameters=&f=pjson&token=')
  .then(function(res) {
    var response = JSON.parse(res.getBody());
    var data = response.features.map(function(attr) {
      return attr.attributes;
    });
    console.log('yay it worked', data);
    return data;
  }).then(function(data) {
    var vlSpec = {
      "description": "arghhhhhhh",
      "data": {
        "values": data
      },
      "mark": "point",
      "encoding": {
        "x": {"field":"ENROLLMENT","type": "quantitative"},
        "y": {"field": "FULL_TIME_","type": "quantitative"}
      }
  //     "mark": "bar",
  // "encoding": {
  //   "x": {"field": "COUNTY","type": "ordinal"},
  //   "y": {"field": "POPULATION","type": "quantitative"}
  // }
    };
    var embedSpec = {
      mode: "vega-lite",
      spec: vlSpec
    };

    vg.embed("#testEverything", embedSpec, function(error, result) {
      if (error) console.log('err ', error);
      console.log('result ', result);
    });
  }).done();


</script>
