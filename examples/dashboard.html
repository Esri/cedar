<!DOCTYPE html>
<!--[if lt IE 7 ]> <html class="ie6"> <![endif]-->
<!--[if IE 7 ]>    <html class="ie7"> <![endif]-->
<!--[if IE 8 ]>    <html class="ie8"> <![endif]-->
<!--[if IE 9 ]>    <html class="ie9"> <![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html class="not-ie"> <!--<![endif]-->
<head>
  <meta charset="utf-8">

  
    <title>Dashboard | Esri Cedar</title>
  

  

  <meta name="description" content="Esri Cedar">
  <meta name="viewport" content="width=device-width">

  <!--[if lt IE 9]>
    <script src="//cdn.jsdelivr.net/html5shiv/3.7.2/html5shiv-printshiv.js"></script>
  <![endif]-->

  <!-- stylesheet -->
  <link rel="stylesheet" href="../../../cedar/css/style.css">
  <link rel="stylesheet" href="../../../cedar/css/calcite-bootstrap.css">

  <script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"></script>

  <!-- Cedar and dependencies (d3, vega) -->
  <!-- NOTE: the pie chart examle does not work w/ latest vega (v1.5+), so here we are pulling in an oldder version (v1.4.3) -->
  
    <script type="text/javascript" src="../../../cedar/js/d3.min.js"></script>
    <script type="text/javascript" src="../../../cedar/js/vega.min.js"></script>
    <script type="text/javascript" src="../../../cedar/js/cedar.js"></script>
  
  <!-- NOTE: underscore is used by a few examples, but is not needed by Cedar -->
  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.7.0/underscore-min.js"></script>

  <!-- NOTE: prism is used by the examples, but is not needed by Cedar -->
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/prism/1.5.0/themes/prism.css">
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/prism/1.5.0/prism.min.js"></script>

  <!-- Google Analytics -->
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-47337822-8', 'auto');
    ga('send', 'pageview');
  </script>
  <!-- End Google Analytics -->
</head>
<body>

  <nav class="navbar navbar-default" role="navigation">
  <div class="container">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="../../../cedar/">cedar.js</a>
    </div>

    <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
      <ul class="nav navbar-nav navbar-right">
        
        <li><a href="../../../cedar/tutorial/">Tutorial</a></li>
        <li><a href="../../../cedar/examples/">Examples</a></li>
        <li><a href="../../../cedar/api/">API</a></li>
        <li><a href="https://github.com/esri/cedar">Github</a></li>
      </ul>
    </div><!-- /.navbar-collapse -->
  </div><!-- /.container-fluid -->
</nav>

  
<link rel="stylesheet" href="https://gridster.net/dist/jquery.gridster.min.css"></link>
<link rel="stylesheet" href="https://gridster.net/assets/css/style.css"></link>

<script type="text/javascript" src="https://gridster.net/assets/js/libs/jquery-1.7.2.min.js"></script>
<script src="https://gridster.net/dist/jquery.gridster.js" type="text/javascript" charset="utf-8"></script>
<style type="text/css">
	.gridster { width: 100%;}
	.widget {
		padding: 5px;
	}
	.chart {
		height: 85%;
		width: 90%;
	}
	.cedar-kpi {
		padding: 20px;
	}
	.cedar-kpi-value {
		font-size: 60px;
	}
	.cedar-kpi-title {
		font-size: 15px;
		color: #888;
	}
</style>
<div class="gridster">
    <label for="dashboardMapId">Map ID</label><input id="dashboardMapId" placeholder="Map ID to power dashboard" />
    <ul id="dashboard">    
    </ul>
</div> 

<script type="text/javascript">
$(function(){ 
	var charts = [];

    $(".gridster ul").gridster({
        widget_margins: [10, 10],
        widget_base_dimensions: [140, 140],
        extra_rows: 20,
        resize: {
        	enabled: true,
        	resize: function() {  charts.forEach(function(chart) { chart.update() }) },
        	stop: function() {  charts.forEach(function(chart) { chart.update() }) }
        }
    });

    function webmapUrl(webmapId) {
		return "https://www.arcgis.com/sharing/rest/content/items/" + webmapId +"/data?f=json";
    }
    function gistUrl(webmapId) {
		return "https://gist.githubusercontent.com/ajturner/" + webmapId + "/raw/webmap.json";
    }    
    function addChart( layer, index ) {
    	var gridster = $(".gridster ul").gridster().data('gridster');
    	gridster.add_widget(
    		'<li class="widget cedar-chart"><h3>' + layer.title +'</h3><div id="chart' + index + '" class="chart"></div></li>',
    		3, 3);  
    	addKpi(layer,index,gridster);
    }
	function addKpi(layer, index, gridster) {
		var count = 0;

		Cedar.getJson(layer.url + "/query?where=1%3D1&outFields=*&returnGeometry=false&returnCountOnly=true&f=json", function(err,data) {
			gridster.add_widget(
	    		'<li class="widget cedar-kpi"><span class="cedar-kpi-value">' + data.count +'</span><br/><span class="cedar-kpi-title">' + layer.title + '</span></div></li>',
	    		3, 1); 

		});
	}
	function getParameterByName(name) {
		name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
		var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
		    results = regex.exec(location.search);
		return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
	}
    function buildCharts(design) {
    	if(design === undefined || design === null) { 
    		return;
    	} else if(typeof design == 'string') {
    		Cedar.getJson(webmapUrl(design), function(err, data) { buildCharts(data); })
    		return;
    	}

    	design.operationalLayers.forEach(function(layer) {
    		Cedar.getJson(layer.url + "?f=json", function(err,data) {
    			var variable = data.fields[0].name;
    			var renderer = layer.layerDefinition.drawingInfo.renderer;
    			var index = renderer.field || renderer.field1;

    			var statsType = "count";
    			var statsName = (index + "_" + statsType);
    			var popupInfo = layer.popupInfo.description;
    			if(popupInfo !== undefined && popupInfo !== null && popupInfo.includes('|')) {
	    			// e.g. "|'type':'scatter','x':'{DP03_62E}'|"
	    			var layerDef = JSON.parse(popupInfo.replace(/\|(.*)\|/g, '{$1}').replace(/'/g,'"'))
	    		}
    			query = {
			      "groupByFieldsForStatistics": index,
			      "outStatistics": [{
			        "statisticType": statsType, 
			        "onStatisticField": index, 
			        "outStatisticFieldName": statsName
			      }]
			    };
    			var layerChart = {"type": "bar",
				  	"dataset": {
					    "url":layer.url,
					    "query": query,
					    "mappings":{
					      "x": {"field": index,"label": index},
					      "y": {"field": statsName,"label": "count"},
					      "sort": statsName + " DESC"
					    }
					},
					"tooltip": {
						"title": "{" +  index + "}: {" + statsName + "} ",
						"content": ""
					}
				  };
			      // console.log("Chart Query", query);

				  var chart = new Cedar(layerChart);
				  charts.push(chart)
				  addChart(layer, charts.length);
				  chart.show({
				    elementId: "#chart" + charts.length
				  });
    		});
    	});
    }

    // DC Dashboard
    // buildCharts('6df835c1de90493a8b813324f5de39a3');

    // Hawaii Dashboard
    var map = 'a95e0bb28dc84a329a83650060922b23';
    document.getElementById("dashboardMapId").onblur = function(evt) {
		var mapId = document.getElementById("dashboardMapId").value;
    	buildCharts(mapId);
    }
    map = getParameterByName('map');
    buildCharts(map);
});
</script>


  <hr>
  <div class="container centered-text">
  <p class="copyright">Cedar is a project from the <a href="http://dc.esri.com">Esri DC R&amp;D Center</a> </p>
</div>

  <!-- <script src="../../../cedar/js/script.js"></script>-->
  </body>
</html>