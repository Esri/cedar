!function(a){"use strict";var b=function c(a){var b=this,d=a||{};if(this._events=[],this._definition=c._defaultDefinition(),this._view=void 0,this._methodQueue=[],this._pendingXhr=!1,d.definition)if("object"==typeof d.definition)this._definition=d.definition;else{if("string"!=typeof d.definition)throw new Error("parameter definition must be an object or string (url)");this._pendingXhr=!0,c.getJson(d.definition,function(a,c){b._pendingXhr=!1,b._definition=c,b._purgeMethodQueue()})}if(d.override&&(this._definition.override=d.override),d.specification)if("object"==typeof d.specification)this._definition.specification=d.specification;else{if("string"!=typeof d.specification)throw new Error("parameter template must be an object or string (url)");this._pendingXhr=!0,c.getJson(d.specification,function(a,c){b._pendingXhr=!1,b._definition.specification=c,b._purgeMethodQueue()})}if(d.dataset&&"object"==typeof d.dataset){var e=c._defaultQuery();d.dataset.query=d.dataset.query?_.defaults(d.dataset.query,e):e,this._definition.dataset=d.dataset}Object.defineProperty(this,"dataset",{get:function(){return this._definition.dataset},set:function(a){this._definition.dataset=a}}),Object.defineProperty(this,"specification",{get:function(){return this._definition.specification},set:function(a){this._definition.specification=a}}),Object.defineProperty(this,"override",{get:function(){return this._definition.override},set:function(a){this._definition.override=a}})};b.prototype.canDraw=function(){return{drawable:!0,errs:[]}},b.prototype.show=function(a){if(this._pendingXhr)this._addToMethodQueue("show",[a]);else{var b;if(a.elementId||(b="Cedar.show requires options.elementId"),null===d3.select(a.elementId)[0][0]&&(b="Element "+a.elementId+" is not present in the DOM"),this._elementId=a.elementId,this._renderer=a.renderer||"canvas",a.token&&(this._token=a.token),b)throw new Error(b);var c=this.canDraw();if(!c.drawable){var d=c.issues.join(",");throw new Error("Chart can not be drawn because: "+d)}this.update()}},b.prototype.update=function(){var a=this;if(this._pendingXhr)this._addToMethodQueue("update");else{this._view&&this._remove(this._view);try{var c=b._applyDefaultsToMappings(this._definition.dataset.mappings,this._definition.specification.inputs),d=JSON.parse(b._supplant(JSON.stringify(this._definition.specification.template),c));if(d=b._mergeRecursive(d,this._definition.override),d.data[0].url&&delete d.data[0].url,this._definition.dataset.data)d.data[0].values=this._definition.dataset.data,this._renderSpec(d);else{var e=b._createFeatureServiceRequest(this._definition.dataset),f=function(b,c){d.data[0].values=c,a._renderSpec(d)};b.getJson(e,f)}}catch(g){throw g}}},b.prototype._renderSpec=function(a){var b=this;try{vg.parse.spec(a,function(a){b._view=a({el:b._elementId,renderer:b._renderer}),b._view.update(),b._attach(b._view)})}catch(c){throw c}},b.prototype.select=function(a){var b=this,c=this._view,d=c.model().scene().items[0].items[0].items;d.forEach(function(c){c.datum.data.attributes[a.key]===a.value&&c.hasPropertySet("hover")&&b._view.update({props:"hover",items:c})})},b.prototype._attach=function(a){a.on("mouseover",this._handler("mouseover")),a.on("mouseout",this._handler("mouseout")),a.on("click",this._handler("click"))},b.prototype._remove=function(a){a.off("mouseover"),a.off("mouseout"),a.off("click")},b._validateMappings=function(a,b){for(var c,d=[],e=0;e<a.length;e++)c=a[e],c.required&&(b[c.name]||d.push(c.name));return d},b._validateData=function(a,c){var d=[];if(!a.features||!Array.isArray(a.features))throw new Error("Data is expected to have features array!");var e=a.features[0].attributes;for(var f in c){var g=b._getMappingFieldName(f,c[f].field);e.hasOwnProperty(g)||d.push(g)}return d},b._getMappingFieldName=function(a,b){var c=b;return"count"===a.toLowerCase()&&(c=b+"_SUM"),c},b._defaultDefinition=function(){var a={dataset:{query:this._defaultQuery()},template:{}};return a.dataset.query=b._defaultQuery(),a},b._defaultQuery=function(){var a={where:"1=1",returnGeometry:!1,returnDistinctValues:!1,returnIdsOnly:!1,returnCountOnly:!1,outFields:"*",f:"json"};return a},b.prototype._handler=function(a){var b=this,c=function(c,d){b._events.forEach(function(b){b.type===a&&b.callback(d.datum.data.attributes)})};return c},b.prototype.on=function(a,b){this._events.push({type:a,callback:b})},b.prototype.off=function(a){console.log("Handler for "+a+" removed...")},b.prototype._addToMethodQueue=function(a,b){this._methodQueue.push({method:a,args:b})},b.prototype._purgeMethodQueue=function(){var a=this;if(a._methodQueue.length>0)for(var b=0;b<a._methodQueue.length;b++){var c=a._methodQueue[b];a[c.method].apply(a,c.args)}},b.getJson=function(a,b){d3.json(a,function(c,d){c&&b("Error loading "+a+" "+c.message),b(null,d)})},b._createFeatureServiceRequest=function(a){var c;if(a.query?(c=_.clone(a.query),_.defaults(c,b._defaultQuery())):c=b._defaultQuery(),c.bbox){if(c.geometry)throw new Error("Dataset.query can not have both a geometry and a bbox specified");var d=c.bbox.split(",");delete c.bbox,c.geometry=JSON.stringify({xmin:d[0],ymin:d[2],xmax:d[1],ymax:d[3]}),c.inSR="4326"}a.mappings.group&&(c.groupByFieldsForStatistics=a.mappings.group.field),a.mappings.count&&(c.orderByFields=a.mappings.count.field+"_SUM",c.outStatistics=JSON.stringify([{statisticType:"sum",onStatisticField:a.mappings.count.field,outStatisticFieldName:a.mappings.count.field+"_SUM"}]));var e=a.url+"/query?"+this._serializeQueryParams(c);return a.token&&(e=e+"&token="+a.token),e},b._applyDefaultsToMappings=function(a,b){for(var c=[],d=0;d<b.length;d++){var e=b[d];e.required&&!a[e.name]&&c.push(e.name),e.required||a[e.name]||!e.default||(a[e.name]=e.default)}if(c.length>0)throw new Error("Required Mappings Missing: "+c.join(","));return a},b._supplant=function(a,c){return console.log("Mappings: ",c),a.replace(/{([^{}]*)}/g,function(a,d){var e=b._getTokenValue(c,d);return"string"==typeof e||"number"==typeof e?e:a})},b._mergeRecursive=function(a,c){for(var d in c)try{a[d]=c[d].constructor===Object||c[d].constructor===Array?b._mergeRecursive(a[d],c[d]):c[d]}catch(e){a[d]=c[d]}return a},b._getTokenValue=function(a,b){for(var c=a,d=b.split("."),e=0;e<d.length;e++){if(!c.hasOwnProperty(d[e]))return null;c=c[d[e]]}return c},b._serializeQueryParams=function(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(encodeURIComponent(c)+"="+encodeURIComponent(a[c]));var d=b.join("&");return d},a.Cedar=b}(window);
//# sourceMappingURL=cedar.min.js.map