!function(a){"use strict";"function"==typeof define&&define.amd?define(["vega","d3"],function(b,c){return a(b,c)}):"object"==typeof module&&"object"==typeof module.exports&&(module.exports=a(require("vega"),require("d3"))),"undefined"!=typeof window&&window.vg&&window.d3&&(window.Cedar=a(window.vg,window.d3))}(function(a,b){"use strict";var c=function(){var a,b="http:",c="//esri.github.io/cedar/js";return window&&window.document?(a=window.document.currentScript&&window.document.currentScript.src,a?a.substr(0,a.lastIndexOf("/")):(window.document.location?window.document.location.protocol:b)+c):b+c}(),d=function a(b){var c,d=this,e=b||{};if(this.width=void 0,this.height=void 0,this.autolabels=!0,this.maxLabelLength=void 0,this._events=[],this._definition=a._defaultDefinition(),this._view=void 0,this._tooltip=void 0,this._methodQueue=[],this._timeout=void 0,b.timeout&&(this._timeout=b.timeout),e.baseUrl&&(this.baseUrl=e.baseUrl),this._pendingXhr=!1,e.definition)if("object"==typeof e.definition)this._definition=e.definition;else{if("string"!=typeof e.definition)throw new Error("parameter definition must be an object or string (url)");this._pendingXhr=!0,a.getJson(e.definition,function(a,b){d._pendingXhr=!1,d._definition=b,d._purgeMethodQueue()},this._timeout)}if(e.override&&(this._definition.override=e.override),c=this._getSpecificationUrl(e.type),e.specification&&(c=e.specification),c)if("object"==typeof c)this._definition.specification=c;else{if("string"!=typeof c)throw new Error("parameter specification must be an object or string (url)");this._pendingXhr=!0,a.getJson(c,function(a,b){d._pendingXhr=!1,d._definition.specification=b,d._purgeMethodQueue()},this._timeout)}if(e.dataset&&"object"==typeof e.dataset&&(e.dataset.query=a._mixin({},a._defaultQuery(),e.dataset.query),this._definition.dataset=e.dataset),Object.defineProperty(this,"dataset",{get:function(){return this._definition.dataset},set:function(a){this._definition.dataset=a}}),Object.defineProperty(this,"specification",{get:function(){return this._definition.specification},set:function(a){this._definition.specification=a}}),Object.defineProperty(this,"override",{get:function(){return this._definition.override},set:function(a){this._definition.override=a}}),Object.defineProperty(this,"tooltip",{get:function(){return this._definition.tooltip},set:function(a){this._definition.tooltip=a,void 0!==this._definition.tooltip.id&&null!==this._definition.tooltip.id||(this._definition.tooltip.id="cedar-"+Date.now())}}),e.tooltip&&"object"==typeof e.tooltip)this.tooltip=e.tooltip;else{var f=[];for(var g in this._definition.dataset.mappings)if(this._definition.dataset.mappings.hasOwnProperty(g)){var h=this._definition.dataset.mappings[g].field;void 0!==h&&null!==h&&f.push(h)}f.length>=2&&(this.tooltip={title:"{"+f[0]+"}",content:"{"+f[1]+"}"})}};return d.prototype.baseUrl=c,d.prototype.chartTypes=["bar","bar-horizontal","bubble","grouped","pie","scatter","sparkline","time","time-trendline"],d.prototype.canDraw=function(){return{drawable:!0,errs:[]}},d.prototype.show=function(a,c){if(this._pendingXhr)this._addToMethodQueue("show",[a,c]);else{var d;if(a.elementId||(d="Cedar.show requires options.elementId"),null===b.select(a.elementId)[0][0]&&(d="Element "+a.elementId+" is not present in the DOM"),this._elementId=a.elementId,this._renderer=a.renderer||"svg",this.width=a.width||void 0,this.height=a.height||void 0,void 0!==a.autolabels&&null!==a.autolabels&&(this.autolabels=a.autolabels),a.maxLabelLength&&(this.maxLabelLength=a.maxLabelLength),a.token&&(this._token=a.token),d)throw new Error(d);var e=this.canDraw();if(!e.drawable){var f=e.issues.join(",");throw new Error("Chart can not be drawn because: "+f)}this.update(c)}},d.prototype.update=function(a){var b=this;if(this._view&&this.emit("update-start"),this._pendingXhr)this._addToMethodQueue("update");else{this._view&&this._remove(this._view);try{void 0!==b._definition.tooltip&&null!==b._definition.tooltip&&b._createTooltip(b._definition.tooltip.id);var c=d._applyDefaultsToMappings(this._definition.dataset.mappings,this._definition.specification.inputs),e=d._mixin({},this._definition.specification.query,this._definition.dataset.query);e=JSON.parse(d._supplant(JSON.stringify(e),c)),c.query=e;var f=JSON.parse(d._supplant(JSON.stringify(this._definition.specification.template),c));if(f=d._mergeRecursive(f,this._definition.override),f.data[0].url&&delete f.data[0].url,this._definition.dataset.data)f.data[0].values=this._definition.dataset.data,this._renderSpec(f,a);else{var g=d._createFeatureServiceRequest(this._definition.dataset,e),h=function(c,d){!c&&d.error&&(c=new Error(d.error.message||d.error.details[0])),c?a&&"function"==typeof a&&a(c,d):(f.data[0].values=d,b._renderSpec(f,a))};d.getJson(g,h,b._timeout)}}catch(a){throw a}}},d.prototype._renderSpec=function(c,d){var e=this;e.autolabels===!0&&(c=e._placeLabels(c),c=e._placeaAxisTicks(c)),a.parse.spec(c,function(a,f){e._view=f({el:e._elementId,renderer:e._renderer});var g=e.width||parseInt(b.select(e._elementId).style("width"),10)||500,h=e.height||parseInt(b.select(e._elementId).style("height"),10)||500;e._view.width(g).height(h).update(),e._attach(e._view),e._view&&e.emit("update-end"),d&&"function"==typeof d&&d(a,c)})},d.prototype._placeLabels=function(a){var b=this;try{var c={},d={},e=[];for(var f in b._definition.dataset.mappings)if(b._definition.dataset.mappings.hasOwnProperty(f)){var g=b._definition.dataset.mappings[f].field;void 0!==g&&null!==g&&(e.push(f),c[f]=g,d[f]=0)}var h=0;return a.data[0].values.features.forEach(function(a){e.forEach(function(e){h=(a.attributes[c[e]]||"").toString().length,b.maxLabelLength&&(h=h<b.maxLabelLength+1?h:b.maxLabelLength),h>d[e]&&(d[e]=h)})}),e.forEach(function(c,e){var f=0;void 0!==a.axes&&void 0!==a.axes[e]&&(void 0!==a.axes[e].properties.labels.angle&&(f=a.axes[e].properties.labels.angle.value),"y"==a.axes[e].type&&(f=100-f),b.maxLabelLength&&(a.axes[e].properties.labels.text={template:"{{ datum.data | truncate:"+b.maxLabelLength+"}}"}),a.axes[e].titleOffset=Math.abs(d[c]*f/100*8)+35)}),a}catch(a){throw a}},d.prototype._placeaAxisTicks=function(a){var c=this;if(void 0!==a.axes)try{var d=c.width||parseInt(b.select(c._elementId).style("width"),10)||500,e=c.height||parseInt(b.select(c._elementId).style("height"),10)||500;a.axes[0].ticks=d/100,void 0!==a.axes[1]&&(a.axes[1].ticks=e/30)}catch(a){throw a}return a},d.prototype.select=function(a){var b=this,c=this._view,d=c.model().scene().items[0].items[0].items;return d.forEach(function(c){c.datum.attributes[a.key]===a.value&&c.hasPropertySet("hover")&&b._view.update({props:"hover",items:c})}),d},d.prototype.clearSelection=function(a){var b=this,c=this._view;if(a&&a.key){var d=c.model().scene().items[0].items[0].items;return d.forEach(function(c){c.datum.attributes[a.key]===a.value&&b._view.update({props:"update",items:c})}),d}return b._view.update(),null},d.prototype.emit=function(a){this._view._handler._handlers[a]&&void 0!==this._view._handler._handlers[a][0]&&this._view._handler._handlers[a][0].handler()},d.prototype._attach=function(a){a.on("mouseover",this._handler("mouseover")),a.on("mouseout",this._handler("mouseout")),a.on("mousemove",this._handler("mousemove")),a.on("click",this._handler("click")),a.on("update-start",this._handler("update-start")),a.on("update-end",this._handler("update-end"))},d.prototype._remove=function(a){a.off("mouseover"),a.off("mouseout"),a.off("mousemove"),a.off("click"),a.off("update-start"),a.off("update-end")},d._validateMappings=function(a,b){for(var c,d=[],e=0;e<a.length;e++)c=a[e],c.required&&(b[c.name]||d.push(c.name));return d},d._validateData=function(a,b){var c=[];if(!a.features||!Array.isArray(a.features))throw new Error("Data is expected to have features array!");var e=a.features[0].attributes;for(var f in b)if(b.hasOwnProperty(f)){var g=d._getMappingFieldName(f,b[f].field);e.hasOwnProperty(g)||c.push(g)}return c},d._getMappingFieldName=function(a,b){var c=b;return c},d._defaultDefinition=function(){var a={dataset:{query:this._defaultQuery()},template:{}};return a.dataset.query=d._defaultQuery(),a},d._defaultQuery=function(){var a={where:"1=1",returnGeometry:!1,returnDistinctValues:!1,returnIdsOnly:!1,returnCountOnly:!1,outFields:"*",sqlFormat:"standard",f:"json"};return a},d.prototype._getSpecificationUrl=function(a){return this.chartTypes.indexOf(a)!==-1&&(a=this.baseUrl+"/charts/"+this.chartTypes[this.chartTypes.indexOf(a)]+".json"),a},d.prototype._handler=function(a){var b=this,c=function(c,d){b._events.forEach(function(b){b.type===a&&(d?b.callback(c,d.datum.attributes):b.callback(c,null))})};return c},d.prototype.on=function(a,b){this._events.push({type:a,callback:b})},d.prototype.off=function(a,b){this._events.forEach(function(c,d,e){c.type==a&&c.callback==b&&e.splice(d,1)})},d.prototype._addToMethodQueue=function(a,b){this._methodQueue.push({method:a,args:b})},d.prototype._purgeMethodQueue=function(){var a=this;if(a._methodQueue.length>0)for(var b=0;b<a._methodQueue.length;b++){var c=a._methodQueue[b];a[c.method].apply(a,c.args)}},d.prototype._createTooltip=function(a){var b=this,c=document.getElementById(a);if(void 0!==c&&null!==c)return c;var d=document.createElement("style");return d.type="text/css",d.innerHTML=".cedar-tooltip {background-color: white; padding: 3px 10px; color: #333; margin: -30px 0 0 20px; position: absolute; z-index: 2000; font-size: 10px; border: 1px solid #BBB;} .cedar-tooltip .title {font-size: 13pt; font-weight: bold; } .cedar-tooltip .content {font-size: 10pt; } ",document.getElementsByTagName("head")[0].appendChild(d),c=document.createElement("div"),c.className="cedar-tooltip",c.id=a,c.style.cssText="display: none",document.body.insertBefore(c,document.body.firstChild),b.on("mouseout",function(a,c){b._updateTooltip(a,null)}),b.on("mousemove",function(a,c){b._updateTooltip(a,c)}),c},d.prototype._updateTooltip=function(a,b){var c=document.getElementById(this._definition.tooltip.id);if(void 0===b||null===b)return void(c.style.display="none");c.style.top=a.pageY+"px",c.style.left=a.pageX+"px",c.style.display="block";var d="<span class='title'>"+this._definition.tooltip.title+"</span><br />";d+="<p class='content'>"+this._definition.tooltip.content+"</p>",c.innerHTML=d.replace(/\{(\w+)\}/g,function(a,c){return b[c]})},d._mixin=function(a){for(var c=1;c<arguments.length;c++)b.entries(arguments[c]).forEach(function(b){a[b.key]=b.value});return a},d.getJson=function(a,c,d){var e=function(b,d){b&&""===b.response?c(new Error("This service is taking too long to respond, unable to chart")):b?c(new Error("Error loading "+a+" "+b.message)):c(null,JSON.parse(d.responseText))};if(a.length>2e3){var f=a.split("?");b.xhr(f[0]).on("beforesend",function(a){a.timeout=d,a.ontimeout=a.onload}).header("Content-Type","application/x-www-form-urlencoded").post(f[1],e)}else b.xhr(a).on("beforesend",function(a){a.timeout=d,a.ontimeout=a.onload}).get(e)},d._createFeatureServiceRequest=function(a,b){var c=d._mixin({},d._defaultQuery(),b);if(c.bbox){if(c.geometry)throw new Error("Dataset.query can not have both a geometry and a bbox specified");var e=c.bbox.split(",");delete c.bbox,c.geometry=JSON.stringify({xmin:e[0],ymin:e[2],xmax:e[1],ymax:e[3]}),c.inSR="4326"}!c.groupByFieldsForStatistics&&a.mappings.group&&(c.groupByFieldsForStatistics=a.mappings.group.field),!c.outStatistics&&a.mappings.count&&(c.orderByFields=a.mappings.count.field+"_SUM",c.outStatistics=JSON.stringify([{statisticType:"sum",onStatisticField:a.mappings.count.field,outStatisticFieldName:a.mappings.count.field+"_SUM"}])),a.mappings.sort&&(c.orderByFields=a.mappings.sort);var f=a.url+"/query?"+this._serializeQueryParams(c);return a.token&&(f=f+"&token="+a.token),f},d._applyDefaultsToMappings=function(a,b){for(var c=[],d=0;d<b.length;d++){var e=b[d];e.required&&!a[e.name]&&c.push(e.name),e.required||a[e.name]||!e.default||(a[e.name]=e.default)}if(c.length>0)throw new Error("Required Mappings Missing: "+c.join(","));return a},d._supplant=function(a,b){var c=a.replace(/{([^{}]*)}/g,function(a,c){var e=d._getTokenValue(b,c);return"string"==typeof e||"number"==typeof e?e:a});return c.replace(/"{([^{}]*)}"/g,function(a,c){var e=d._getTokenValue(b,c);return e.constructor===Array?e=JSON.stringify(e):a})},d._mergeRecursive=function(a,b){for(var c in b)if(b.hasOwnProperty(c))try{b[c].constructor===Object||b[c].constructor===Array?a[c]=d._mergeRecursive(a[c],b[c]):a[c]=b[c]}catch(d){a[c]=b[c]}return a},d._getTokenValue=function(a,b){for(var c=a,d=b.split("."),e=0;e<d.length;e++){if(!c.hasOwnProperty(d[e]))return null;c=c[d[e]]}return c},d._serializeQueryParams=function(a){var b=[];for(var c in a)if(a.hasOwnProperty(c)){var d=a[c];"string"!=typeof d&&(d=JSON.stringify(d)),b.push(encodeURIComponent(c)+"="+encodeURIComponent(d))}var e=b.join("&");return e},d});
//# sourceMappingURL=cedar.min.js.map