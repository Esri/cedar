/**
* arcgis-cedar - v0.9.0 - Thu Feb 23 2017 16:55:27 GMT-0500 (EST)
* Copyright (c) 2017 Environmental Systems Research Institute, Inc.
* Apache-2.0
*/
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("d3"),require("vega")):"function"==typeof define&&define.amd?define(["d3","vega"],e):t.Cedar=e(t.d3,t.vg)}(this,function(t,e){"use strict";function i(e){for(var i=arguments.length,n=Array(i);i--;)n[i]=arguments[i];for(var r=[].concat(n),o=1;o<r.length;o++)t.entries(r[o]).forEach(function(t){e[t.key]=t.value});return e}function n(t,e){for(var i in e)if(e.hasOwnProperty(i))try{e[i].constructor===Object||e[i].constructor===Array?t[i]=n(t[i],e[i]):t[i]=e[i]}catch(n){t[i]=e[i]}return t}function r(t,e){var i=t.replace(/{([^{}]*)}/g,function(t,i){var n=o(e,i);return"string"==typeof n||"number"==typeof n?n:t});return i.replace(/"{([^{}]*)}"/g,function(t,i){var n=o(e,i);return n&&n.constructor===Array?JSON.stringify(n):t})}function o(t,e){for(var i=t,n=e.split("."),r=0;r<n.length;r++){if(!i.hasOwnProperty(n[r]))return null;i=i[n[r]]}return i}function a(t,e){return t.filter(function(t){if(t.required&&!e[t.name])return t})}function s(t,e){var i=[];if(!t.features||!Array.isArray(t.features))throw new Error("Data is expected to have features array!");var n=t.features[0].attributes;for(var r in e)if(e.hasOwnProperty(r)){var o=u(r,e[r].field);n.hasOwnProperty(o)||i.push(o)}return i}function u(t,e){var i=e;return i}function d(){return{dataset:{query:p()},template:{}}}function p(){return{where:"1=1",returnGeometry:!1,returnDistinctValues:!1,returnIdsOnly:!1,returnCountOnly:!1,outFields:"*",sqlFormat:"standard",f:"json"}}function l(t,e){for(var i=[],n=0;n<e.length;n++){var r=e[n];r.required&&!t[r.name]&&i.push(r.name),r.required||t[r.name]||!r.default||(t[r.name]=r.default)}if(i.length>0)throw new Error("Required Mappings Missing: "+i.join(","));return t}function f(t,e,i,n){n||(n={query:this.defaultQuery()});var r={},o=[],a=[],s=[];t.forEach(function(t){t.query&&o.push(t.query),t.url&&a.push(t.url),t.data&&s.push(t.data),"grouped"===i?(r.group||(r.group=e[0].category),r.x||(r.x={field:[],label:e[0].value.label}),e.length>1?e.forEach(function(t){r.x.field.push("attributes."+t.value.field)}):r.x.field.push("attributes."+e[0].value.field)):"bubble"===i?(r.x=e[0].category,r.y=e[0].value,r.size=e[0].size):"scatter"===i?(r.x=e[0].category,r.y=e[0].value,r.color=e[0].color):"pie"===i?(r.label=e[0].category,r.y=e[0].value,r.radius=e[0].radius):"bar-horizontal"===i?(r.y=e[0].category,r.x=e[0].value):"time"===i?(r.time=e[0].category,r.value=e[0].value):"time-trendline"===i?(r.time=e[0].category,r.value=e[0].value,r.trendline=e[0].trendline):(r.x=e[0].category,r.y=e[0].value)});var u={query:c(o,n.query),mappings:r};return s.length>0&&(u.data=s[0]),a.length>0&&(u.url=h(a)),u}function c(t,e){return t.length>1?(console.warn("Warning, currently multiple queries is not supported. Reverting to default.",t),e):t[0]?t[0]:e}function h(t){return t.length>1?(console.warn("Warning, currently multiple URLS are not supported. Using first url",t),t[0]):t[0]}function m(t){var e=[];for(var i in t)if(t.hasOwnProperty(i)){var n=t[i];"string"!=typeof n&&(n=JSON.stringify(n)),e.push(encodeURIComponent(i)+"="+encodeURIComponent(n))}var r=e.join("&");return r}function g(e,i,n){var r=function(t,n){t&&""===t.response?i(new Error("This service is taking too long to respond, unable to chart")):t?i(new Error("Error loading "+e+" with a response of: "+t.message)):i(null,JSON.parse(n.responseText))};if(e.length>2e3){var o=e.split("?");t.xhr(o[0]).on("beforesend",function(t){t.timeout=n,t.ontimeout=t.onload}).header("Content-Type","application/x-www-form-urlencoded").post(o[1],r)}else t.xhr(e).on("beforesend",function(t){t.timeout=n,t.ontimeout=t.onload}).get(r)}function v(t,e){var n=i({},p(),e);if(n.bbox){if(n.geometry)throw new Error("Dataset.query can not have both a geometry and a bbox specified");var r=n.bbox.split(",");delete n.bbox,n.geometry=JSON.stringify({xmin:r[0],ymin:r[2],xmax:r[1],ymax:r[3]}),n.inSR="4326"}!n.groupByFieldsForStatistics&&t.mappings.group&&(n.groupByFieldsForStatistics=t.mappings.group.field),!n.outStatistics&&t.mappings.count&&(n.orderByFields=t.mappings.count.field+"_SUM",n.outStatistics=JSON.stringify([{statisticType:"sum",onStatisticField:t.mappings.count.field,outStatisticFieldName:t.mappings.count.field+"_SUM"}])),t.mappings.sort&&(n.orderByFields=t.mappings.sort);var o=t.url+"/query?"+m(n);return t.token&&(o=o+"&token="+t.token),o}var _="0.9.0",y={mixin:i,supplant:r,mergeRecursive:n,getTokenValue:o,validateMappings:a,validateData:s,getMappingFieldName:u},b={defaultDefinition:d,defaultQuery:p,applyDefaultsToMappings:l,convertDatasetsToDataset:f},w={getJson:g,createFeatureServiceRequest:v},x=function(){var t,e="http:",i="//esri.github.io/cedar/js";return window&&window.document?(t=window.document.currentScript&&window.document.currentScript.src,t?t.substr(0,t.lastIndexOf("/")):(window.document.location?window.document.location.protocol:e)+i):e+i}(),S=function(t){var e=this;this.version=_;var i,n=t||{};if(this.baseUrl=x,this.chartTypes=["bar","bar-horizontal","bubble","grouped","pie","scatter","sparkline","time","time-trendline"],this.width=void 0,this.height=void 0,this.autolabels=!0,this.maxLabelLength=void 0,this._events=[],this._definition=b.defaultDefinition(),this._view=void 0,this._tooltip=void 0,this._transform=void 0,this._methodQueue=[],this._timeout=void 0,n.timeout&&(this._timeout=n.timeout),n.baseUrl&&(this.baseUrl=n.baseUrl),this._pendingXhr=!1,n.definition)if("object"==typeof n.definition)this._definition=n.definition;else{if("string"!=typeof n.definition)throw new Error("parameter definition must be an object or string (url)");this._pendingXhr=!0,w.getJson(n.definition,function(t,i){if(t)throw new Error("Error fetching definition object",t);e._pendingXhr=!1,e._definition=i,e._purgeMethodQueue()},this._timeout)}if(n.override&&(this._definition.override=n.override),this._chartType=n.type,i=this._getSpecificationUrl(n.type),n.specification&&(i=n.specification),i)if("object"==typeof i)this._definition.specification=i;else{if("string"!=typeof i)throw new Error("parameter specification must be an object or string (url)");this._pendingXhr=!0,this._pendingXhr=!0,w.getJson(i,function(t,i){if(t)throw new Error("Error fetching template object",t);e._pendingXhr=!1,e._definition.specification=i,e._purgeMethodQueue()},this._timeout)}if(n.dataset&&"object"==typeof n.dataset&&(n.dataset.query=y.mixin({},b.defaultQuery(),n.dataset.query),this._definition.dataset=n.dataset),n.datasets&&Array.isArray(n.datasets)&&(this._definition.datasets=n.datasets),n.series&&Array.isArray(n.series)&&(this._definition.series=n.series),n.tooltip&&"object"==typeof n.tooltip)this.tooltip=n.tooltip;else{var r=[];for(var o in this._definition.dataset.mappings)if(e._definition.dataset.mappings.hasOwnProperty(o)){var a=e._definition.dataset.mappings[o].field;void 0!==a&&null!==a&&r.push(a)}r.length>=2&&(this.tooltip={title:"{"+r[0]+"}",content:"{"+r[1]+"}"})}n.transform&&"function"==typeof n.transform&&(this._transform=n.transform)},E={dataset:{},datasets:{},series:{},specification:{},override:{},tooltip:{},transform:{}};return E.dataset.get=function(){return this._definition.dataset},E.dataset.set=function(t){this._definition.dataset=t},E.datasets.get=function(){return this._definition.datasets},E.datasets.set=function(t){this._definition.datasets=t},E.series.get=function(){return this._definition.series},E.series.set=function(t){this._definition.series=t},E.specification.get=function(){return this._definition.specification},E.specification.set=function(t){this._definition.specification=t},E.override.get=function(){return this._definition.override},E.override.set=function(t){this._definition.override=t},E.tooltip.get=function(){return this._definition.tooltip},E.tooltip.set=function(t){this._definition.tooltip=t,void 0!==this._definition.tooltip.id&&null!==this._definition.tooltip.id||(this._definition.tooltip.id="cedar-"+Date.now())},E.transform.get=function(){return this._transform},E.transform.set=function(t){this._transform=t},S.prototype._getSpecificationUrl=function(t){return this.chartTypes.indexOf(t)!==-1&&(t=this.baseUrl+"/charts/"+this.chartTypes[this.chartTypes.indexOf(t)]+".json"),t},S.prototype.canDraw=function(){return{drawable:!0,errs:[]}},S.prototype.show=function(e,i){if(this._pendingXhr)this._addToMethodQueue("show",[e,i]);else{var n;if(e.elementId||(n="Cedar.show requires options.elementId"),null===t.select(e.elementId)[0][0]&&(n="Element "+e.elementId+" is not present in the DOM"),this._elementId=e.elementId,this._renderer=e.renderer||"svg",this.width=e.width||this.height,this.height=e.height||this.height,void 0!==e.autolabels&&null!==e.autolabels&&(this.autolabels=e.autolabels),e.maxLabelLength&&(this.maxLabelLength=e.maxLabelLength),e.token&&(this._token=e.token),n)throw new Error(n);var r=this.canDraw();if(!r.drawable){var o=r.issues.join(",");throw new Error("Chart can not be drawn because: "+o)}this.update(i)}},S.prototype.update=function(t){var e=this;if(this._view&&this.emit("update-start"),this._pendingXhr)this._addToMethodQueue("update");else{this._view&&this._remove(this._view);try{this._definition.tooltip&&this._createTooltip(this._definition.tooltip.id),this._definition.datasets&&this._definition.series&&(this._definition.dataset=b.convertDatasetsToDataset(this._definition.datasets,this._definition.series,this._chartType,this._definition.dataset));var i=b.applyDefaultsToMappings(this._definition.dataset.mappings,this._definition.specification.inputs),n=y.mixin({},this._definition.specification.query,this._definition.dataset.query);n=JSON.parse(y.supplant(JSON.stringify(n),i)),i.query=n;var r=JSON.parse(y.supplant(JSON.stringify(this._definition.specification.template),i));if(r=y.mergeRecursive(r,this._definition.override),r.data[0].url&&delete r.data[0].url,this._definition.dataset.data)r.data[0].values=this._definition.dataset.data,this._renderSpec(r,t);else{var o=w.createFeatureServiceRequest(this._definition.dataset,n),a=function(i,n){!i&&n.error&&(i=new Error(n.error.message||n.error.details[0])),i?t&&"function"==typeof t&&t(i,n):(e._transform&&"function"==typeof e._transform&&(n=e._transform(n,e._definition.dataset)),r.data[0].values=n,e._renderSpec(r,t))};w.getJson(o,a,this._timeout)}}catch(t){throw t}}},S.prototype._renderSpec=function(i,n){var r=this;this.autolabels===!0&&(i=this._placeLabels(i),i=this._placeaAxisTicks(i)),e.parse.spec(i,function(e,o){r._view=o({el:r._elementId,renderer:r._renderer});var a=r.width||parseInt(t.select(r._elementId).style("width"),10)||500,s=r.height||parseInt(t.select(r._elementId).style("height"),10)||500;r._view.width(a).height(s).update(),r._attach(r._view),r._view&&r.emit("update-end"),n&&"function"==typeof n&&n(e,i)})},S.prototype._placeLabels=function(t){var e=this;try{var i={},n={},r=[];for(var o in this._definition.dataset.mappings)if(e._definition.dataset.mappings.hasOwnProperty(o)){var a=e._definition.dataset.mappings[o].field;a&&(r.push(o),i[o]=a,n[o]=0)}var s=0;return t.data[0].values.features.forEach(function(t){r.forEach(function(r){s=(t.attributes[i[r]]||"").toString().length,e.maxLabelLength&&(s=s<e.maxLabelLength+1?s:e.maxLabelLength),s>n[r]&&(n[r]=s)})}),r.forEach(function(i,r){var o=0;t.axes&&t.axes[r]&&(t.axes[r].properties.labels.angle&&(o=t.axes[r].properties.labels.angle.value),"y"===t.axes[r].type&&(o=100-o),e.maxLabelLength&&(t.axes[r].properties.labels.text={template:'{{ datum.data | truncate:"'+e.maxLabelLength+'"}}'}),t.axes[r].titleOffset=Math.abs(n[i]*o/100*8)+35)}),t}catch(t){throw t}},S.prototype._placeaAxisTicks=function(e){if(e.axes)try{var i=this.width||parseInt(t.select(this._elementId).style("width"),10)||500,n=this.height||parseInt(t.select(this._elementId).style("height"),10)||500;e.axes[0].ticks=i/100,e.axes[1]&&(e.axes[1].ticks=n/30)}catch(t){throw t}return e},S.prototype._createTooltip=function(t){var e=this,i=document.getElementById(t);if(i)return i;var n=document.createElement("style");return n.type="text/css",n.innerHTML=".cedar-tooltip {background-color: white; padding: 3px 10px; color: #333; margin: -30px 0 0 20px; position: absolute; z-index: 2000; font-size: 10px; border: 1px solid #BBB;} .cedar-tooltip .title {font-size: 13pt; font-weight: bold; } .cedar-tooltip .content {font-size: 10pt; } ",document.getElementsByTagName("head")[0].appendChild(n),i=document.createElement("div"),i.className="cedar-tooltip",i.id=t,i.cssText="display: none",document.body.insertBefore(i,document.body.firstChild),this.on("mouseout",function(t,i){e._updateTooltip(t,null)}),this.on("mousemove",function(t,i){e._updateTooltip(t,i)}),i},S.prototype._updateTooltip=function(t,e){var i=document.getElementById(this._definition.tooltip.id);if(!e)return void(i.style.display="none");i.style.top=t.pageY+"px",i.style.left=t.pageX+"px",i.style.display="block";var n="<span class='title'>"+this._definition.tooltip.title+"</span><br />";n+="<p class='content'>"+this._definition.tooltip.content+"</p>",i.innerHTML=n.replace(/\{(\w+)\}/g,function(t,i){return e[i]})},S.prototype.on=function(t,e){this._events.push({type:t,callback:e})},S.prototype.off=function(t,e){this._events.forEach(function(i,n,r){i.type===t&&i.callback===e&&r.splice(n,1)})},S.prototype.emit=function(t){this._view._handler._handlers[t]&&this._view._handler._handlers[t][0]&&this._view._handler._handlers[t][0].handler()},S.prototype._attach=function(t){t.on("mouseover",this._handler("mouseover")),t.on("mouseout",this._handler("mouseout")),t.on("mousemove",this._handler("mousemove")),t.on("click",this._handler("click")),t.on("update-start",this._handler("update-start")),t.on("update-end",this._handler("update-end"))},S.prototype._remove=function(t){t.off("mouseover"),t.off("mouseout"),t.off("mousemove"),t.off("click"),t.off("update-start"),t.off("update-end")},S.prototype._addToMethodQueue=function(t,e){this._methodQueue.push({method:t,args:e})},S.prototype._purgeMethodQueue=function(){var t=this;this._methodQueue.length>0&&this._methodQueue.forEach(function(e,i){t[e.method].apply(t,e.args)})},S.prototype._handler=function(t){var e=this,i=function(i,n){e._events.forEach(function(e){e.type===t&&(n?e.callback(i,n.datum.attributes):e.callback(i,null))})};return i},S.prototype.select=function(t){var e=this,i=this._view,n=i.model().scene().items[0].items[0].items;return n.forEach(function(i){i.datum.attributes[t.key]===t.value&&i.hasPropertySet("hover")&&e._view.update({props:"hover",items:i})}),n},S.prototype.clearSelection=function(t){var e=this,i=this._view;if(t&&t.key){var n=i.model().scene().items[0].items[0].items;return n.forEach(function(i){i.datum.attributes[t.key]===t.value&&e._view.update({props:"update",items:i})}),n}return this._view.update(),null},S.getJson=function(t,e,i){return w.getJson(t,e,i)},S._validateMappings=function(t,e){return y.validateMappings(t,e)},S._validateData=function(t,e){return y.validateData(t,e)},S._createFeatureServiceRequest=function(t,e){return w.createFeatureServiceRequest(t,e)},S._getMappingFieldName=function(t,e){return y.getMappingFieldName(t,e)},S._convertDatasetsToDataset=function(t,e,i){return b.convertDatasetsToDataset(t,e,i)},Object.defineProperties(S.prototype,E),S});
//# sourceMappingURL=cedar.min.js.map
