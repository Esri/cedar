/**
* arcgis-cedar - v0.8.1 - Tue Jan 10 2017 20:55:44 GMT-0800 (PST)
* Copyright (c) 2017 Environmental Systems Research Institute, Inc.
* Apache-2.0
*/
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("d3"),require("vega")):"function"==typeof define&&define.amd?define(["d3","vega"],e):t.Cedar=e(t.d3,t.vg)}(this,function(t,e){"use strict";function i(e){for(var i=arguments.length,n=Array(i);i--;)n[i]=arguments[i];for(var o=[].concat(n),r=1;r<o.length;r++)t.entries(o[r]).forEach(function(t){e[t.key]=t.value});return e}function n(t,e){for(var i in e)if(e.hasOwnProperty(i))try{e[i].constructor===Object||e[i].constructor===Array?t[i]=n(t[i],e[i]):t[i]=e[i]}catch(n){t[i]=e[i]}return t}function o(t,e){var i=t.replace(/{([^{}]*)}/g,function(t,i){var n=r(e,i);return"string"==typeof n||"number"==typeof n?n:t});return i.replace(/"{([^{}]*)}"/g,function(t,i){var n=r(e,i);return n&&n.constructor===Array?JSON.stringify(n):t})}function r(t,e){var i=t,n=e.split(".");for(var o in n){if(!i.hasOwnProperty(n[o]))return null;i=i[n[o]]}return i}function a(t,e){return t.filter(function(t){if(t.required&&!e[t.name])return t})}function s(t,e){var i=[];if(!t.features||!Array.isArray(t.features))throw new Error("Data is expected to have features array!");var n=t.features[0].attributes;for(var o in e)if(e.hasOwnProperty(o)){var r=u(o,e[o].field);n.hasOwnProperty(r)||i.push(r)}return i}function u(t,e){var i=e;return i}function d(){return{dataset:{query:p()},template:{}}}function p(){return{where:"1=1",returnGeometry:!1,returnDistinctValues:!1,returnIdsOnly:!1,returnCountOnly:!1,outFields:"*",sqlFormat:"standard",f:"json"}}function f(t,e){for(var i=[],n=0;n<e.length;n++){var o=e[n];o.required&&!t[o.name]&&i.push(o.name),o.required||t[o.name]||!o.default||(t[o.name]=o.default)}if(i.length>0)throw new Error("Required Mappings Missing: "+i.join(","));return t}function h(t){var e=[];for(var i in t)if(t.hasOwnProperty(i)){var n=t[i];"string"!=typeof n&&(n=JSON.stringify(n)),e.push(encodeURIComponent(i)+"="+encodeURIComponent(n))}var o=e.join("&");return o}function c(e,i,n){var o=function(t,n){t&&""===t.response?i(new Error("This service is taking too long to respond, unable to chart")):t?i(new Error("Error loading "+e+" with a response of: "+t.message)):i(null,JSON.parse(n.responseText))};if(e.length>2e3){var r=e.split("?");t.xhr(r[0]).on("beforesend",function(t){t.timeout=n,t.ontimeout=t.onload}).header("Content-Type","application/x-www-form-urlencoded").post(r[1],o)}else t.xhr(e).on("beforesend",function(t){t.timeout=n,t.ontimeout=t.onload}).get(o)}function l(t,e){var n=i({},p(),e);if(n.bbox){if(n.geometry)throw new Error("Dataset.query can not have both a geometry and a bbox specified");var o=n.bbox.split(",");delete n.bbox,n.geometry=JSON.stringify({xmin:o[0],ymin:o[2],xmax:o[1],ymax:o[3]}),n.inSR="4326"}!n.groupByFieldsForStatistics&&t.mappings.group&&(n.groupByFieldsForStatistics=t.mappings.group.field),!n.outStatistics&&t.mappings.count&&(n.orderByFields=t.mappings.count.field+"_SUM",n.outStatistics=JSON.stringify([{statisticType:"sum",onStatisticField:t.mappings.count.field,outStatisticFieldName:t.mappings.count.field+"_SUM"}])),t.mappings.sort&&(n.orderByFields=t.mappings.sort);var r=t.url+"/query?"+h(n);return t.token&&(r=r+"&token="+t.token),r}var m="0.8.1",_={mixin:i,supplant:o,mergeRecursive:n,getTokenValue:r,validateMappings:a,validateData:s,getMappingFieldName:u},v={defaultDefinition:d,defaultQuery:p,applyDefaultsToMappings:f},g={getJson:c,createFeatureServiceRequest:l},y=function(){var t,e="http:",i="//esri.github.io/cedar/js";return window&&window.document?(t=window.document.currentScript&&window.document.currentScript.src,t?t.substr(0,t.lastIndexOf("/")):(window.document.location?window.document.location.protocol:e)+i):e+i}(),w=function(t){var e=this;this.version=m;var i,n=t||{};if(this.baseUrl=y,this.chartTypes=["bar","bar-horizontal","bubble","grouped","pie","scatter","sparkline","time","time-trendline"],this.width=void 0,this.height=void 0,this.autolabels=!0,this.maxLabelLength=void 0,this._events=[],this._definition=v.defaultDefinition(),this._view=void 0,this._tooltip=void 0,this._transform=void 0,this._methodQueue=[],this._timeout=void 0,n.timeout&&(this._timeout=n.timeout),n.baseUrl&&(this.baseUrl=n.baseUrl),this._pendingXhr=!1,n.definition)if("object"==typeof n.definition)this._definition=n.definition;else{if("string"!=typeof n.definition)throw new Error("parameter definition must be an object or string (url)");this._pendingXhr=!0,g.getJson(n.definition,function(t,i){if(t)throw new Error("Error fetching definition object",t);e._pendingXhr=!1,e._definition=i,e._purgeMethodQueue()},this._timeout)}if(n.override&&(this._definition.override=n.override),i=this._getSpecificationUrl(n.type),n.specification&&(i=n.specification),i)if("object"==typeof i)this._definition.specification=i;else{if("string"!=typeof i)throw new Error("parameter specification must be an object or string (url)");this._pendingXhr=!0,this._pendingXhr=!0,g.getJson(i,function(t,i){if(t)throw new Error("Error fetching template object",t);e._pendingXhr=!1,e._definition.specification=i,e._purgeMethodQueue()},this._timeout)}if(n.dataset&&"object"==typeof n.dataset&&(n.dataset.query=_.mixin({},v.defaultQuery(),n.dataset.query),this._definition.dataset=n.dataset),n.tooltip&&"object"==typeof n.tooltip)this.tooltip=n.tooltip;else{var o=[];for(var r in this._definition.dataset.mappings)if(e._definition.dataset.mappings.hasOwnProperty(r)){var a=e._definition.dataset.mappings[r].field;void 0!==a&&null!==a&&o.push(a)}o.length>=2&&(this.tooltip={title:"{"+o[0]+"}",content:"{"+o[1]+"}"})}n.transform&&"function"==typeof n.transform&&(this._transform=n.transform)},b={dataset:{},specification:{},override:{},tooltip:{},transform:{}};return b.dataset.get=function(){return this._definition.dataset},b.dataset.set=function(t){this._definition.dataset=t},b.specification.get=function(){return this._definition.specification},b.specification.set=function(t){this._definition.specification=t},b.override.get=function(){return this._definition.override},b.override.set=function(t){this._definition.override=t},b.tooltip.get=function(){return this._definition.tooltip},b.tooltip.set=function(t){this._definition.tooltip=t,void 0!==this._definition.tooltip.id&&null!==this._definition.tooltip.id||(this._definition.tooltip.id="cedar-"+Date.now())},b.transform.get=function(){return this._transform},b.transform.set=function(t){this._transform=t},w.prototype._getSpecificationUrl=function(t){return this.chartTypes.indexOf(t)!==-1&&(t=this.baseUrl+"/charts/"+this.chartTypes[this.chartTypes.indexOf(t)]+".json"),t},w.prototype.canDraw=function(){return{drawable:!0,errs:[]}},w.prototype.show=function(e,i){if(this._pendingXhr)this._addToMethodQueue("show",[e,i]);else{var n;if(e.elementId||(n="Cedar.show requires options.elementId"),null===t.select(e.elementId)[0][0]&&(n="Element "+e.elementId+" is not present in the DOM"),this._elementId=e.elementId,this._renderer=e.renderer||"svg",this.width=e.width||this.height,this.height=e.height||this.height,void 0!==e.autolabels&&null!==e.autolabels&&(this.autolabels=e.autolabels),e.maxLabelLength&&(this.maxLabelLength=e.maxLabelLength),e.token&&(this._token=e.token),n)throw new Error(n);var o=this.canDraw();if(!o.drawable){var r=o.issues.join(",");throw new Error("Chart can not be drawn because: "+r)}this.update(i)}},w.prototype.update=function(t){var e=this;if(this._view&&this.emit("update-start"),this._pendingXhr)this._addToMethodQueue("update");else{this._view&&this._remove(this._view);try{this._definition.tooltip&&this._createTooltip(this._definition.tooltip.id);var i=v.applyDefaultsToMappings(this._definition.dataset.mappings,this._definition.specification.inputs),n=_.mixin({},this._definition.specification.query,this._definition.dataset.query);n=JSON.parse(_.supplant(JSON.stringify(n),i)),i.query=n;var o=JSON.parse(_.supplant(JSON.stringify(this._definition.specification.template),i));if(o=_.mergeRecursive(o,this._definition.override),o.data[0].url&&delete o.data[0].url,this._definition.dataset.data)o.data[0].values=this._definition.dataset.data,this._renderSpec(o,t);else{var r=g.createFeatureServiceRequest(this._definition.dataset,n),a=function(i,n){!i&&n.error&&(i=new Error(n.error.message||n.error.details[0])),i?t&&"function"==typeof t&&t(i,n):(e._transform&&"function"==typeof e._transform&&(n=e._transform(n,e._definition.dataset)),o.data[0].values=n,e._renderSpec(o,t))};g.getJson(r,a,this._timeout)}}catch(t){throw t}}},w.prototype._renderSpec=function(i,n){var o=this;this.autolabels===!0&&(i=this._placeLabels(i),i=this._placeaAxisTicks(i)),e.parse.spec(i,function(e,r){o._view=r({el:o._elementId,renderer:o._renderer});var a=o.width||parseInt(t.select(o._elementId).style("width"),10)||500,s=o.height||parseInt(t.select(o._elementId).style("height"),10)||500;o._view.width(a).height(s).update(),o._attach(o._view),o._view&&o.emit("update-end"),n&&"function"==typeof n&&n(e,i)})},w.prototype._placeLabels=function(t){var e=this;try{var i={},n={},o=[];for(var r in this._definition.dataset.mappings)if(e._definition.dataset.mappings.hasOwnProperty(r)){var a=e._definition.dataset.mappings[r].field;a&&(o.push(r),i[r]=a,n[r]=0)}var s=0;return t.data[0].values.features.forEach(function(t){o.forEach(function(o){s=(t.attributes[i[o]]||"").toString().length,e.maxLabelLength&&(s=s<e.maxLabelLength+1?s:e.maxLabelLength),s>n[o]&&(n[o]=s)})}),o.forEach(function(i,o){var r=0;t.axes&&t.axes[o]&&(t.axes[o].properties.labels.angle&&(r=t.axes[o].properties.labels.angle.value),"y"===t.axes[o].type&&(r=100-r),e.maxLabelLength&&(t.axes[o].properties.labels.text={template:'{{ datum.data | truncate:"'+e.maxLabelLength+'"}}'}),t.axes[o].titleOffset=Math.abs(n[i]*r/100*8)+35)}),t}catch(t){throw t}},w.prototype._placeaAxisTicks=function(e){if(e.axes)try{var i=this.width||parseInt(t.select(this._elementId).style("width"),10)||500,n=this.height||parseInt(t.select(this._elementId).style("height"),10)||500;e.axes[0].ticks=i/100,e.axes[1]&&(e.axes[1].ticks=n/30)}catch(t){throw t}return e},w.prototype._createTooltip=function(t){var e=this,i=document.getElementById(t);if(i)return i;var n=document.createElement("style");return n.type="text/css",n.innerHTML=".cedar-tooltip {background-color: white; padding: 3px 10px; color: #333; margin: -30px 0 0 20px; position: absolute; z-index: 2000; font-size: 10px; border: 1px solid #BBB;} .cedar-tooltip .title {font-size: 13pt; font-weight: bold; } .cedar-tooltip .content {font-size: 10pt; } ",document.getElementsByTagName("head")[0].appendChild(n),i=document.createElement("div"),i.className="cedar-tooltip",i.id=t,i.cssText="display: none",document.body.insertBefore(i,document.body.firstChild),this.on("mouseout",function(t,i){e._updateTooltip(t,null)}),this.on("mousemove",function(t,i){e._updateTooltip(t,i)}),i},w.prototype._updateTooltip=function(t,e){var i=document.getElementById(this._definition.tooltip.id);if(!e)return void(i.style.display="none");i.style.top=t.pageY+"px",i.style.left=t.pageX+"px",i.style.display="block";var n="<span class='title'>"+this._definition.tooltip.title+"</span><br />";n+="<p class='content'>"+this._definition.tooltip.content+"</p>",i.innerHTML=n.replace(/\{(\w+)\}/g,function(t,i){return e[i]})},w.prototype.on=function(t,e){this._events.push({type:t,callback:e})},w.prototype.off=function(t,e){this._events.forEach(function(i,n,o){i.type===t&&i.callback===e&&o.splice(n,1)})},w.prototype.emit=function(t){this._view._handler._handlers[t]&&this._view._handler._handlers[t][0]&&this._view._handler._handlers[t][0].handler()},w.prototype._attach=function(t){t.on("mouseover",this._handler("mouseover")),t.on("mouseout",this._handler("mouseout")),t.on("mousemove",this._handler("mousemove")),t.on("click",this._handler("click")),t.on("update-start",this._handler("update-start")),t.on("update-end",this._handler("update-end"))},w.prototype._remove=function(t){t.off("mouseover"),t.off("mouseout"),t.off("mousemove"),t.off("click"),t.off("update-start"),t.off("update-end")},w.prototype._addToMethodQueue=function(t,e){this._methodQueue.push({method:t,args:e})},w.prototype._purgeMethodQueue=function(){var t=this;this._methodQueue.length>0&&this._methodQueue.forEach(function(e,i){t[e.method].apply(t,e.args)})},w.prototype._handler=function(t){var e=this,i=function(i,n){e._events.forEach(function(e){e.type===t&&(n?e.callback(i,n.datum.attributes):e.callback(i,null))})};return i},w.prototype.select=function(t){var e=this,i=this._view,n=i.model().scene().items[0].items[0].items;return n.forEach(function(i){i.datum.attributes[t.key]===t.value&&i.hasPropertySet("hover")&&e._view.update({props:"hover",items:i})}),n},w.prototype.clearSelection=function(t){var e=this,i=this._view;if(t&&t.key){var n=i.model().scene().items[0].items[0].items;return n.forEach(function(i){i.datum.attributes[t.key]===t.value&&e._view.update({props:"update",items:i})}),n}return this._view.update(),null},w.getJson=function(t,e,i){return g.getJson(t,e,i)},w._validateMappings=function(t,e){return _.validateMappings(t,e)},w._validateData=function(t,e){return _.validateData(t,e)},w._createFeatureServiceRequest=function(t,e){return g.createFeatureServiceRequest(t,e)},w._getMappingFieldName=function(t,e){return _.getMappingFieldName(t,e)},Object.defineProperties(w.prototype,b),w});
//# sourceMappingURL=cedar.min.js.map
